{% extends 'default_frame.twig' %}

{% set body_class = 'cart_page' %}

{% block stylesheet %}
    <style type="text/css">
        .modal .modal-header .close {
            float: right;
            font-size: 21px;
            font-weight: 700;
            line-height: 1;
            color: #000;
            text-shadow: 0 1px 0 #fff;
            filter: alpha(opacity=20);
            opacity: .2;
        }
    </style>
{% endblock stylesheet %}

{% block javascript %}
    <script type="text/javascript">
        $(function() {
            $(".plus").on("click", function() {
                var $button = $(this);
                var oldValue = $button.parent().find("input[type=number]").val();
                var newVal = parseInt(oldValue) + 1;
                var max = $button.parent().find("input[type=number]").attr('max');
                if (newVal > max) {
                    return false;
                }
                var priceSpan = $button.parent().parent().find(".count-price").find("span");
                if ($(this).data('text') == 'history') {
                    var priceOld = parseInt($button.parent().parent().find(".old-price").val());
                    var priceNew = priceOld * newVal;
                } else {
                    var priceOld = parseInt(priceSpan.text());
                    var priceNew = priceOld / oldValue * newVal;
                }
                priceSpan.text(priceNew);
                $button.parent().find("input[type=number]").val(newVal);
            });

            $(".minus").on("click", function() {
                var $button = $(this);
                var oldValue = $button.parent().find("input[type=number]").val();
                var priceSpan = $button.parent().parent().find(".count-price").find("span");
                var min = $button.parent().find("input[type=number]").attr('min');
                if (oldValue > min) {
                    var newVal = parseInt(oldValue) - 1;
                } else return false;
                if ($(this).data('text') == 'history') {
                    var priceOld = parseInt($button.parent().parent().find(".old-price").val());
                    var priceNew = priceOld * newVal;
                } else {
                    var priceOld = parseInt(priceSpan.text());
                    var priceNew = priceOld / oldValue * newVal;
                }
                priceSpan.text(priceNew);
                $button.parent().find("input[type=number]").val(newVal);
            });

            // reset modal
            $('.modal').on('hidden.bs.modal', function(){
                $(this).find('form')[0].reset();
                $('.old-price').each(function () {
                    var old_price = $(this).val();
                    $(this).parent().find('.count-price').find('span').text(old_price);
                });
            });

            $(".exhibition li").click(function () {
                var $class = $(this).data('text');
                $(this).parent().find('li').each(function (index, value) {
                    $(value).removeClass('enable').addClass('disable');
                    $('.'+$(value).data('text')).hide();
                });
                $(this).addClass('enable').removeClass('disable');
                $('.'+$class).show();
            });

            var section = '{{ app.request.get('section', '') }}';
            if (section) {
                $('#'+section+'-section').trigger('click');
            }
        });
    </script>
{% endblock javascript %}

{% block main %}
    <div id="receiver-cart-wrapper" class="wrapper">
        <div class="container">
            <div class="exhibition">
                <div class="row">
                    <div class="col-sm-12 col-xs-12">
                        <ul class="list-inline">
                            <li class="col-sm-6 col-xs-6 text-alight-center enable" id="cart-section" data-text="cart-section">注文票</li>
                            <li class="col-sm-6 col-xs-6 text-alight-center disable" id="history-section" data-text="history-section">注文履歴</li>
                        </ul>
                    </div>
                </div>
            </div>

            {% set productStr = app.session.flashbag.get('eccube.front.request.product') %}
            {% for error in app.session.flashbag.get('eccube.front.request.error')  %}
                {% set idx = loop.index0 %}
                {% if productStr[idx] is defined %}
                    <div id="cart_box__message--{{ loop.index }}" class="message">
                        <p class="errormsg bg-danger">
                            {{ error|trans({'%product%':productStr[idx]})|nl2br }}
                        </p>
                    </div>
                {% else %}
                    <div id="cart_box__message--{{ loop.index }}" class="message">
                        <p class="errormsg bg-danger">
                            {{ error|trans|nl2br }}
                        </p>
                    </div>
                {% endif %}
            {% endfor %}
            {% for error in app.session.flashbag.get('eccube.front.cart.error')  %}
                <div id="cart_box__message_error--{{ loop.index }}" class="message">
                    <p class="errormsg bg-danger">
                        {{ error|trans|nl2br }}
                    </p>
                </div>
            {% endfor %}

            {% if Cart.CartItems|length > 0 %}
                <div class="cart-section row">
                    <div class="col-sm-12 col-xs-12">
                        <div class="backgroundf7f7f7">
                            <div class="title-section-small backgroundf7f7f7">
                                <p>お届け先バス停</p>
                            </div>

                            <div class="title-section-white">
                                <p>エスパルスドリームプラザ</p>
                                <span>静岡県静岡市清水区入船町13-15</span>
                            </div>

                            {% for reception_date in reception_dates %}
                                <div class="cart-title">
                                    <p>
                                        <span class="cart-main-title">{{ reception_date|date('m月d日') }}({{ master_date[reception_date|date('N')].name }})</span>
                                        <span class="cart-sub-title">お届け予定</span>
                                    </p>
                                </div>

                                <div class="cart-content" id="cart-main-content">
                                    <form method="post" action="?">
                                        <input type="hidden" name="mode" value="confirm">
                                        <input type="hidden" name="date" value="{{ reception_date|date('Y/m/d') }}">
                                    {% for CartItem in Cart.CartItems %}
                                        {% if CartItem.reception_date|date('U') == reception_date|date('U') %}
                                            {% set ProductClass = CartItem.Object %}
                                            {% set Product = ProductClass.Product %}
                                            {% set Customer = Product.Creator %}
                                            <div class="receiver-cart clearfix">
                                                <div>
                                                    <div class="order-detail-profile float-left">
                                                        <img src="{{ app.config.image_save_urlpath }}/{{ Product.MainListImage|no_image_product }}" class="cart-profile">
                                                        <span class="profile-name-medium">{{ Product.name }}</span>
                                                        <span class="profile-address-medium">{{ Customer.__toString }}</span>
                                                        <span class="profile-order-medium">注文点数：{{ CartItem.quantity }}</span>
                                                    </div>
                                                    <div class="float-right arrow-right">
                                                        <img src="{{ app.config.front_urlpath }}/yasai-bus/img/icon/arrow.png" >
                                                    </div>
                                                </div>

                                                <div class="cart-detail-info">
                                                    <div class="float-left">
                                                        <p>小計：{{ CartItem.total_price|number_format }}</p>
                                                    </div>
                                                    <div class="float-right">
                                                        <a href="#" class="cart-link" data-toggle="modal" data-target="#cartModal">注文内容の変更</a>
                                                        <a href="{{ url('cart_remove', {'productClassId': ProductClass.id, 'date': reception_date|date('Y/m/d') }) }}" {{ csrf_token_for_anchor() }} data-method="put" data-message="カートから商品を削除してもよろしいですか?" class="delete-link">削除</a>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    <div class="product-cart-button">
                                        {#<p>あと2時間30分で自動的に注文が確定されます</p>#}
                                        <button class="cart-button-confirm btn btn-success" type="submit">注文内容を確認する</button>
                                    </div>
                                    </form>
                                </div>

                            {% endfor %}
                        </div>
                    </div>
                </div>

            {% else %}
                <div id="cart_box__message" class="message">
                    <p class="errormsg bg-danger">
                        現在カート内に商品はございません。
                    </p>
                </div>
            {% endif %}

            <div class="history-section">
                <div class="row">
                    <div class="col-sm-12 col-xs-12">
                        <form name="form1" id="form1" method="get" action="?">
                            <input type="hidden" name="section" value="history">
                            {{ form_widget(form_order_by.order_by, {attr: {'onchange': 'javascript:this.form.submit();'}}) }}
                        </form>
            {% if order_history|length > 0 %}
                {% for row in order_history %}
                    {% set Product = row.product %}
                        <div class="receiver-order-detail clearfix">
                            <div class="clearfix">
                                <div class="order-detail-profile float-left">
                                    <img src="{{ app.config.image_save_urlpath }}/{{ Product.MainListImage|no_image_product }}" alt="profile" class="order-profile">
                                    <span class="profile-name-medium">{{ Product.name }}</span>
                                    <span class="profile-address-medium">{{ Product.Creator.__toString }}</span>
                                </div>
                                <div class="float-right arrow-right">
                                    <img src="{{ app.config.front_urlpath }}/yasai-bus/img/icon/arrow.png" >
                                </div>
                            </div>
                            <div class="order-detail-info">
                                <div class="float-left">
                                    <p><span class="fix-length1">最終注文日</span><span>{{ row.order_date|date("Y年m月d日") }}</span></p>
                                    <p><span class="fix-length1">注文合計</span><span>{{ row.order_time }}回</span></p>
                                </div>
                                <div class="float-right link-success">
                                    <a href="#" data-toggle="modal" data-target="#product-modal-{{ Product.id }}">再注文する</a>
                                    <div class="modal fade" id="product-modal-{{ Product.id }}" tabindex="-1" data-backdrop="static" data-keyboard="false" role="dialog" aria-labelledby="cartModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                {% set cartForm = forms[Product.id] %}
                                                <form name="add-cart-form" id="add-cart-form-{{ Product.id }}" method="post" action="?">
                                                    <input type="hidden" name="mode" value="add_cart"/>
                                                    {{ form_widget(cartForm._token) }}
                                                    {{ form_widget(cartForm.product_id) }}
                                                    {{ form_widget(cartForm.product_class_id) }}
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="cartModalLabel">配送日をお選びください</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        {{ form_errors(cartForm.quantity) }}
                                                        {% set ProductRDs = Product.ProductReceiptableDates %}
                                                        {% for ProductRD in ProductRDs %}
                                                            <div class="row">
                                                                <div class="col-sm-12 col-xs-12 count-modal">
                                                                    <div class="col-sm-8 col-xs-8 float-left">
                                                                        <span class="count-date">{{ ProductRD.date|date('m月d日') }}({{ ProductRD.ReceiptableDate.name }})</span>
                                                                        <label class="count-quality ">残り{{ ProductRD.max_quantity }}点</label>
                                                                        <input type="hidden" class="old-price" value="{{ Product.Price02IncTaxMin }}">
                                                                        <p class="count-price">小計：<span class="modal-price">0</span>円</p>
                                                                    </div>
                                                                    <div class="col-sm-4 col-xs-4 float-right count-right">
                                                                        <img class="minus" src="{{ app.config.front_urlpath }}/yasai-bus/img/icon/count-minus-inactive.svg" data-text="history">
                                                                        <input type="number" min="0" step="1" max="{{ ProductRD.max_quantity }}" pattern="[0-9]*" class="count-number"
                                                                               name="quantity[{{ ProductRD.date|date('Y/m/d') }}]" value="0">
                                                                        <img class="plus" src="{{ app.config.front_urlpath }}/yasai-bus/img/icon/count-plus-active.svg" data-text="history">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button id="order_button" class="btn btn-success" type="submit">注文票に追加する</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                {% endfor %}
            {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if Cart.CartItems|length > 0 %}
        <div class="modal fade" id="cartModal" tabindex="-1" data-backdrop="static" data-keyboard="false" role="dialog" aria-labelledby="cartModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form name="modify-cart" id="modify-cart" method="post" action="{{ url('cart_modify') }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="cartModalLabel">配送日をお選びください</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            {% for CartItem in Cart.CartItems %}
                                {% set ProductClass = CartItem.Object %}
                                {% set Product = ProductClass.Product %}
                                <div class="row">
                                    <div class="col-sm-12 col-xs-12 count-modal">
                                        <div class="col-sm-8 col-xs-8 float-left">
                                            <span class="count-date">{{ CartItem.reception_date|date('m月d日') }}({{ master_date[CartItem.reception_date|date('N')].name }})</span>
                                            <span>{{ Product.name }}</span>
                                            <input type="hidden" class="old-price" value="{{ CartItem.total_price }}">
                                            <p class="count-price">小計：<span class="price_{{ ProductClass.id }}_{{ CartItem.reception_date|date('N') }}">{{ CartItem.total_price }}</span>円</p>
                                        </div>
                                        <div class="col-sm-4 col-xs-4 float-right count-right">
                                            <img class="minus" src="{{ app.config.front_urlpath }}/yasai-bus/img/icon/count-minus-inactive.svg">
                                            <input type="number" min="1" max="{{ Product.getStockByDate(CartItem.reception_date) }}" step="1" pattern="[0-9]*" class="count-number"
                                                   name="quantity[{{ ProductClass.id }}][{{ CartItem.reception_date|date('Y/m/d') }}]"
                                                   value="{{ CartItem.quantity }}">
                                            <img class="plus" src="{{ app.config.front_urlpath }}/yasai-bus/img/icon/count-plus-active.svg">
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="modal-footer">
                            <button id="order_button" class="btn btn-success" type="submit">注文内容を変更する</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
